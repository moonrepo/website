---
title: Continuous Integration (CI)
icon: Repeat
---

import { Tab, Tabs } from "fumadocs-ui/components/tabs";

All companies and projects rely on continuous integration (CI) to ensure high quality code and to
avoid regressions. Because this is such a critical piece of every developer's workflow, we wanted to
support it as a first-class feature within moon, and we do just that with the
[`moon ci`](../commands/ci) command.

## How it works

The [`moon ci`](../commands/ci) command does all the heavy lifting necessary for effectively running jobs. It achieves this by automatically running the following steps:

- Determines changed files by comparing the current HEAD against a base.
- Determines all [targets](../target) that need to run based on changed files.
- Additionally runs affected [targets](../target) dependencies _and_ dependents.
- Generates an [action graph](../action#action-graph) (dependency graph).
- Installs the applicable [toolchains](../toolchain) for each running task.
- Runs all [actions](../action) within the graph using a thread pool.
- Displays stats about all passing, failed, and invalid [actions](../action).

## Configuring tasks to run

By default, _all tasks_ run in CI, as you should always be building, linting, typechecking, testing,
so on and so forth. However, this isn't always true, so this can be disabled on a per-task basis
through [`options.runInCI`](../task#runinci).

```yaml
tasks:
  dev:
    command: "start-server"
    options:
      runInCI: false
```

<Callout type="warning">
  This option _must_ be set to false for tasks that spawn a long-running or
  never-ending process, like HTTP or development servers. To help mitigate this,
  tasks named `dev`, `start`, or `serve` are false by default.
</Callout>

## Integrating with a provider

The following examples can be referenced for setting up moon and its CI workflow in popular
providers. For GitHub, we're using our
[`setup-toolchain` action](https://github.com/moonrepo/setup-toolchain) to install moon. For other
providers, we assume moon is an npm dependency and must be installed with Node.js.

<Tabs groupId="ci-env" items={['GitHub', 'Buildkite', 'CircleCI', 'TravisCI']}>
<Tab>

```yaml title=".github/workflows/ci.yml"
name: "Pipeline"
on:
  push:
    branches:
      - "master"
  pull_request:
jobs:
  ci:
    name: "CI"
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v4"
        with:
          fetch-depth: 0
      - uses: "moonrepo/setup-toolchain@v0"
      - run: "moon ci"
```

</Tab>
<Tab>

```yaml title=".buildkite/pipeline.yml"
steps:
  - label: "CI"
    commands:
      - "yarn install --immutable"
      - "moon ci"
```

</Tab>
<Tab>

```yaml title=".circleci/config.yml"
version: 2.1
orbs:
  node: "circleci/node@7.2.0"
jobs:
  ci:
    docker:
      - image: "cimg/base:stable"
    steps:
      - checkout
      - node/install:
          install-yarn: true
          node-version: "24.0.0"
      - node/install-packages:
          check-cache: "always"
          pkg-manager: "yarn-berry"
      - run: "moon ci"
workflows:
  pipeline:
    jobs:
      - "ci"
```

</Tab>
<Tab>

```yaml title=".travis.yml"
language: "node_js"
node_js:
  - 24
cache: "yarn"
script: "moon ci"
```

</Tab>
</Tabs>

## Choosing explicit tasks

By default [`moon ci`](../commands/ci) will run _all_ tasks from _all_ projects that are affected by changed files and have [`options.runInCI`](../task#runinci) enabled. This is a great catch-all solution, but may not vibe with your workflow or requirements.

If you'd prefer more control, you can pass a list of targets to [`moon ci`](../commands/ci), instead of moon
attempting to detect them. When providing targets, [`moon ci`](../commands/ci) will still only run them if affected by
changed files, but will still filter with [`options.runInCI`](../task#runinci).

```shell
# Run all builds
$ moon ci :build

# In another job, run tests
$ moon ci :test :lint
```

## Comparing revisions

By default the command will attempt to detect the base and head revisions automatically based on the
current CI provider (powered by the [`ci_env`](https://github.com/milesj/rust-cicd-env) Rust crate).
If nothing was detected, this will fallback to the configured
[`vcs.defaultBranch`](../workspace#defaultbranch) for the base revision, and `HEAD` for the
head revision.

These values can be customized with the `--base` and `--head` command line options, or the
`MOON_BASE` and `MOON_HEAD` environment variables, which takes highest precedence.

```shell
$ moon ci --base <REV> --head <REV>
# Or
$ MOON_BASE=<REV> MOON_HEAD=<REV> moon ci
```

## Parallelizing tasks

If your CI environment supports sharding across multiple jobs, then you can utilize moon's built in
parallelism by passing `--job-total` and `--job` options. The `--job-total` option is an integer of
the total number of jobs available, and `--job` is the current index (0 based) amongst the total.

When these options are passed, moon will only run affected [targets](../target) based on
the current job slice.

<Tabs groupId="ci-env" items={['GitHub', 'Buildkite', 'CircleCI', 'TravisCI']}>
<Tab>

```yaml title=".github/workflows/ci.yml"
# ...
jobs:
  ci:
    # ...
    strategy:
      matrix:
        index: [0, 1]
    steps:
      # ...
      - run: "moon ci --job ${{ matrix.index }} --job-total 2"
```

- GitHub Actions do not support native parallelism, but it can be emulated using it's matrix.
- [Documentation](https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs)

</Tab>
<Tab>

```yaml title=".buildkite/pipeline.yml"
# ...
steps:
  - label: "CI"
    parallelism: 10
    commands:
      # ...
      - "moon ci --job $BUILDKITE_PARALLEL_JOB --job-total $BUILDKITE_PARALLEL_JOB_COUNT"
```

- [Documentation](https://buildkite.com/docs/tutorials/parallel-builds#parallel-jobs)

</Tab>
<Tab>

```yaml title=".circleci/config.yml"
# ...
jobs:
  ci:
    # ...
    parallelism: 10
    steps:
      # ...
      - run: "moon ci --job $CIRCLE_NODE_INDEX --job-total $CIRCLE_NODE_TOTAL"
```

- [Documentation](https://circleci.com/docs/guides/optimize/parallelism-faster-jobs/)

</Tab>
<Tab>

```yaml title=".travis.yml"
# ...
env:
  global:
    - TRAVIS_JOB_TOTAL=2
  jobs:
    - TRAVIS_JOB_INDEX=0
    - TRAVIS_JOB_INDEX=1
script: "moon ci --job $TRAVIS_JOB_INDEX --job-total $TRAVIS_JOB_TOTAL"
```

- TravisCI does not support native parallelism, but it can be emulated using it's matrix.
- [Documentation](https://docs.travis-ci.com/user/speeding-up-the-build/)

</Tab>
</Tabs>

<Callout>Your CI may provide environment variables for these 2 values.</Callout>
